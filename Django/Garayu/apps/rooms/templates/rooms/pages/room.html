{% extends "global/partials/headbase.html" %}
{% block title %}Room {{room.name}}{% endblock title %}
{% block body %}
    {% include "global/partials/background.html" %}
    <div class="room-container">
        <div class="players" id="players">
            <h2>Players:</h2>
            {% for user_in_room in all_users_in_room %}
                <p>{% if user_in_room.host %}<i class="fa-solid fa-crown"></i>{% else %}<i class="fa-solid fa-user"></i>{% endif %} {{user_in_room.user.first_name}}</p>
            {% endfor %}
        </div>
        <div class="controls">
            <form class="leave-room" method="POST" action="{% url "rooms:rooms_leave" %}">
                {% csrf_token %}
                <button type="submit">Leave</button>
            </form>
            {% if is_host %}
                <div class="configs">
                    
                </div>
                <button id="start-game">Start Game</button>
            {% else %}
                <p>Waiting for the host to start the game...</p>
            {% endif %}
        </div>
    </div>

    <script>
        $(document).ready(function () {
            function getUsersInRoom() {
                $.ajax({
                    url: '{% url "rooms:get_users_in_room" room.slug %}',
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        // Update the users list
                        updateUsersList(data.users);
                    },
                    error: function () {
                        console.error('Failed to fetch users in the room.');
                    },
                });
            }

            function updateUsersList(users) {
                var usersList = $('#players');
                usersList.empty();  // Clear the existing list
                
                var titleElement = $('<h2>').text("Players:");
                usersList.append(titleElement);
                // Append each user to the list
                users.forEach(function (user) {
                    var userElement = $('<p>');
                    if (user.host) {
                        var userCrown = $('<i>').addClass("fa-solid fa-crown");
                        userElement.prepend(userCrown);
                    } else {
                        var userIcon = $('<i>').addClass("fa-solid fa-user");
                        userElement.prepend(userIcon);
                    }
                    userElement.append(' ' + user.nickname);
                    usersList.append(userElement);
                });
            }

            // Fetch users every second
            getInterval = setInterval(getUsersInRoom, 1000);

            // Start the game

            function game_started() {
                console.log('Comecou !');
            }

            function checkRoomAvailability() {
                $.ajax({
                    url: '{% url "game:game_checking" room.slug %}',
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        if (data.started) {
                            console.log('Jogo iniciou');
                            clearInterval(checkInterval);
                            clearInterval(getInterval);
                            game_started();
                        }
                    },
                    error: function () {
                        console.error('Failed to check room availability.');
                    },
                });
            }
            
            // Check every second if the room started
            checkInterval = setInterval(checkRoomAvailability, 1000);
        });
    </script>
    <script>
        $(document).ready(function () { 

            $('#start-game').on('click', function () {
                $.ajax({
                    url: '{% url "game:game_start" room.slug %}',
                    type: 'POST',
                    dataType: 'json',
                    success: function (data) {
                        $('#start-game').prop("disabled", true);
                    },
                    error: function () {
                        console.error('Failed to obtain a response.');
                    },
                });
            });

        });
    </script>

{% endblock body %}